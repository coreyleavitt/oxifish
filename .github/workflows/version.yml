name: Bump Version

on:
  workflow_dispatch:
    inputs:
      bump:
        description: 'Version bump type'
        required: true
        type: choice
        options:
          - patch
          - minor
          - major
      prerelease:
        description: 'Prerelease type (optional)'
        required: false
        type: choice
        options:
          - ''
          - alpha
          - beta

permissions:
  contents: write

jobs:
  bump-version:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v4

      - name: Bump version
        id: bump
        run: |
          if [ -n "${{ inputs.prerelease }}" ]; then
            uv version --bump ${{ inputs.bump }} --prerelease ${{ inputs.prerelease }}
          else
            uv version --bump ${{ inputs.bump }}
          fi
          echo "version=$(uv version --short)" >> $GITHUB_OUTPUT

      - name: Update Cargo.toml version
        run: |
          VERSION="${{ steps.bump.outputs.version }}"
          sed -i "s/^version = \".*\"/version = \"$VERSION\"/" Cargo.toml

      - name: Commit version bump (signed via API)
        run: |
          VERSION="${{ steps.bump.outputs.version }}"

          # Create blob for pyproject.toml
          PYPROJECT_CONTENT=$(base64 -w 0 pyproject.toml)
          PYPROJECT_SHA=$(gh api repos/${{ github.repository }}/git/blobs \
            -f content="$PYPROJECT_CONTENT" \
            -f encoding=base64 \
            --jq '.sha')

          # Create blob for Cargo.toml
          CARGO_CONTENT=$(base64 -w 0 Cargo.toml)
          CARGO_SHA=$(gh api repos/${{ github.repository }}/git/blobs \
            -f content="$CARGO_CONTENT" \
            -f encoding=base64 \
            --jq '.sha')

          # Create tree with both files
          TREE_SHA=$(gh api repos/${{ github.repository }}/git/trees \
            --raw-field base_tree="${{ github.sha }}" \
            --raw-field 'tree=[{"path":"pyproject.toml","mode":"100644","type":"blob","sha":"'"$PYPROJECT_SHA"'"},{"path":"Cargo.toml","mode":"100644","type":"blob","sha":"'"$CARGO_SHA"'"}]' \
            --jq '.sha')

          # Create commit
          COMMIT_SHA=$(gh api repos/${{ github.repository }}/git/commits \
            -f message="Bump version to $VERSION [skip ci]" \
            -f tree="$TREE_SHA" \
            -f "parents[]=${{ github.sha }}" \
            --jq '.sha')

          # Update ref
          gh api repos/${{ github.repository }}/git/refs/heads/${{ github.ref_name }} \
            -X PATCH \
            -f sha="$COMMIT_SHA"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
